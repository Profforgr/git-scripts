# Some bash code to get information about the current SCM repository.
#
# Usage: add ". .bash-scm" into your .bashrc
#
# Description of the functions:
#
# $(current_scm_info)
#
#    This can be used to display the current branch or revision inside the
#    bash prompt by adding $(current_scm_info) into the PS1 string.
#
# $(tab_title)
#
#    Information to display as the tab title. To avoid having a too long
#    string this output the name of the repository (if any) and the current
#    working directory. If outside a repository then the last two
#    directories are output. It is possible to pass one agurment true/false
#    to tab_title which is to output the hostname as prefix followed by
#    ':'. So the full format is:
#
#    host:[repository] dir
#

function current_git_branch() {
   local result git_dir git_state
   result=$(git symbolic-ref HEAD 2>/dev/null)
   result=${result##refs/heads/}
   git_dir=$(git rev-parse --git-dir 2> /dev/null) || return

   if test -d "$git_dir/rebase-merge"; then
      git_state=" - rebase - "
   elif test -f "$git_dir/rebase-apply"; then
      git_state=" - am - "
   elif test -f "$git_dir/BISECT_LOG"; then
      git_state=" - bisect - "
   fi

   echo "$result$git_state"
}

function current_cvs_repo_name() {
   local result=$(< CVS/Repository)
   echo "${result%%/*}"
}

function current_cvs_repo() {
   if [[ -f CVS/Repository ]] ; then
      echo "$(current_cvs_repo_name)"
   fi
}

function current_svn_rev() {
   if [[ -d .svn ]] ; then
      echo "r$(LANG=C svn info | \
         sed -n -e '/^Revision: \([0-9]*\).*$/s//\1/p')"
   fi
}

function current_scm_info() {
   local mygitinfo="$(current_git_branch)"

   if [ -z $SCM_INFO_FORMAT ]; then
      SCM_INFO_FORMAT="(%s)"
   fi

   if [[ -n ${mygitinfo} ]] ; then
      if [[ -d $(git_root)/.git/svn ]]; then
         printf $SCM_INFO_FORMAT "git-svn'${mygitinfo}"
      else
         printf $SCM_INFO_FORMAT "git'${mygitinfo}"
      fi
      return
   fi

   local mycvsinfo=$(current_cvs_repo)
   if [[ -n ${mycvsinfo} ]] ; then
         printf $SCM_INFO_FORMAT "cvs'${mycvsinfo}"
         return
   fi

   local mysvninfo=$(current_svn_rev)
   if [[ -n ${mysvninfo} ]] ; then
         printf $SCM_INFO_FORMAT "svn'${mysvninfo}"
   fi
}

function git_root() {
   while [[ ! "$PWD" = "/" && ! -d $PWD/.git ]]; do
      cd ..
   done
   echo $PWD
}

function git_repository_name() {
   echo $(basename "$(git_root)")
}

function svn_root() {
   LAST=$PWD
   while [[ ! "$PWD" = "/" && -d $PWD/.svn ]]; do
      LAST=$PWD
      cd ..
   done
   echo $LAST
}

function svn_repository_name() {
   echo $(basename "$(svn_root)")
}

function tab_title() {
   local cdir=$(basename "$PWD")

   if [[ "$1" == "true" ]]; then
       HNAME="$(hostname):";
   fi;

   if [[ -n $(current_git_branch) ]] ; then
       echo "$HNAME[$(git_repository_name)] $cdir"
   elif [[ -n $(current_svn_rev) ]] ; then
       echo "$HNAME[$(svn_repository_name)] $cdir"
   elif [[ -n $(current_cvs_repo) ]] ; then
       echo "$HNAME[$(current_cvs_repo_name)] $cdir"
   else
       rdir=$(dirname "$PWD")
       echo $HNAME$(basename "$rdir")/$cdir
   fi
}

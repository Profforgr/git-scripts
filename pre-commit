#!/bin/sh

GNATROOT=/opt/gnat/2007

PATH=$GNATROOT/bin:$HOME/bin:$PATH

res=0

REP=/tmp/_$$

# Look for the Git root directory
ROOT=`pwd`
while [ ! "$ROOT" = "" -a ! -d $ROOT/.git ]; do
   cd ..
   ROOT=`pwd`
done

# Repository name
REPOSIT=`basename $ROOT`

[ "$REPOSIT" == "" ] && echo No repository found && exit 1;

# Set Style_Checker options

OWEB="-H -cP -cY -l256"

case "$REPOSIT" in
   *) SC_OPTS="-ign out -ign tmplt -ign sed -ign txt -lang Ada -cp -cy -sp -gnat05 -lang TXML $OWEB -lang XML $OWEB -lang HTML $OWEB -lang XSD $OWEB -lang CSS $OWEB"
   ;;
esac

# Process each file

function check() {
   id=$4
   file=`basename $6`
   mode=$5
   # skip deleted files
   if [ "$mode" = "D" ]; then
       return 0;
   fi
   git show $id > $REP/$file
   ( cd $REP; style_checker $SC_OPTS -n "$6" "$file"; )
   res=$(($res + $?))
   rm -f $REP/$file
}

mkdir $REP

# Get files to be commited
# <N1> <N2> <Id-OLD> <Id-NEW> <status> <Filename>
git-diff-index -M --cached HEAD > $REP/files

while read list
do
   check $list
done < $REP/files

rm -fr $REP

exit $res
